package com.domosekai.cardemulator

import android.media.RingtoneManager
import android.nfc.cardemulation.HostApduService
import android.os.Bundle
import androidx.lifecycle.MutableLiveData
import java.text.SimpleDateFormat
import java.util.*
import kotlin.concurrent.schedule

class HCEService : HostApduService() {

    companion object {
        const val STATUS_SUCCESS = "9000"
        const val STATUS_FAILED = "6A82"
        const val CLA_NOT_SUPPORTED = "6E00"
        const val INS_NOT_SUPPORTED = "6D00"
        var cardType = 0
        var tuType = 0
        var cuOnly = false
        var tuOnly = false
        var cuIssuer = ""
        var tuIssuer = ""
        var app = 0
        var inTU = false
        var metro = false
        var inGate = false
        var metroLine = ""
        var metroStationName = ""
        var metroRemark = ""
        var metroCity = ""
        var metroInstitution = ""
        var metroStationIn = ""
        var metroTerminalIn = ""
        var prefix = ""
        var wait = false
        var waitID = 0
        val rawMessage = MutableLiveData("")
        var commands = ""
        var terminals = MutableLiveData("")
        var cuCustom = emptyMap<String, String>()
        var tuCustom = emptyMap<String, String>()
        val df = SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SSS")
        val df1 = SimpleDateFormat("yyyyMMddHHmmss")
        val df2 = SimpleDateFormat("yyyyMMdd")
    }

    override fun onDeactivated(reason: Int) {
        rawMessage.value += df.format(Date()) + "\n"
        rawMessage.value += "Deactivated: $reason\n\n"
        if (wait) {
            waitID++
            val current = waitID
            Timer().schedule(600) {
                if (current == waitID) wait = false
            }
        }
    }

    override fun processCommandApdu(commandApdu: ByteArray?, extras: Bundle?): ByteArray {
        if (commandApdu == null) {
            return hexStringToByteArray(STATUS_FAILED)
        }
        val tran = parseAPDU(commandApdu)
        // Block duplicate read during waiting period
        if (wait && tran.command == "00A4" && (!metro || cardType == 0 || tuType == 0))
            return hexStringToByteArray(STATUS_FAILED)

        rawMessage.value += df.format(Date()) + "\n"
        when (tran.command) {
            "00B0" -> rawMessage.value += "READ INFO ${"%02X".format(tran.p1 and 0x1F)}\n"
            "00B2" -> rawMessage.value += "READ RECORD ${"%02X".format(tran.p2 shr 3)} " +
                    "${getRecordNo(tran.p1, tran.p2)}\n"
            "80CA" -> rawMessage.value += "GET DATA\n"
            "8050" -> rawMessage.value += "INIT\n"
            "805C" -> rawMessage.value += "GET BALANCE\n"
            "80DC" -> rawMessage.value += "UPDATE RECORD ${"%02X".format(tran.p2 shr 3)} " +
                    "${getRecordNo(tran.p1, tran.p2)}\n"
        }
        rawMessage.value += "Command: ${tran.query}\n"
        commands += tran.query + "\n"

        // Get custom response
        var result = if (inTU) {
            tuCustom[tran.query]
        } else {
            cuCustom[tran.query]
        }
        if (result != null) {
            rawMessage.value += "Response: ${result}\n\n"
            return hexStringToByteArray(result)
        }

        // Get predefined response
        when (tran.command) {
            // SELECT
            "00A4" -> {
                app = 0
                when (tran.data) {
                    "3F00", "1001" -> result = ""
                    "315055422E5359532E4444463031" ->
                        if (cardType == TYPE_HZ && !wait && !tuOnly) {
                            result = "6F15840E315055422E5359532E4444463031A503880101"
                            inTU = false
                        }
                    "325041592E5359532E4444463031" ->
                        if (tuType > 0 && !wait && !cuOnly) {
                            result =
                                "6F49840E325041592E5359532E4444463031A537BF0C3461194F08A000000632010106500A4D4F545F545F4341534887010161174F08A00000063201010550084D4F545F545F4550870102"
                        }
                    "A000000632010105" ->
                        if (tuType > 0 && !wait && !cuOnly) {
                            result =
                                "6F318408A000000632010105A5259F0801029F0C1E01011000FFFFFFFF02010310517001017090798420190806204012310000"
                            app = 2
                            inTU = true
                        }
                    "91560000144D4F542E424D4143303031" ->
                        if (tuType == TU_BJ) {
                            result = "6F12841091560000144D4F542E424D4143303031"
                            app = 3
                        }
                    "5041592E535A54" ->
                        if (cardType == TYPE_SZT) {
                            result =
                                "6F3284075041592E535A54A5279F0801029F0C200000000000000000FD44000051800000E63C1D29201712012027120110100000"
                            inTU = false
                        }
                    "5041592E41505059" ->
                        if (cardType == TYPE_YCT) {
                            result = "6F0A84085041592E41505059"
                            inTU = false
                        }
                    "ADF1" ->
                        if (cardType == TYPE_YCT) {
                            tran.result = "6F0A84085041592E4D4631586A81"
                            inTU = false
                        }
                    "5041592E5449434C" ->
                        if (cardType == TYPE_YCT) {
                            result =
                                "6F3484085041592E5449434CA5289F0801029F0C21FFFFFFFFFFFFFFFF000000000000000000000000000000002019120700000186A0"
                            app = 1
                            inTU = false
                        }
                    "535558494E2E4444463031", "DF01" ->
                        if (cardType == TYPE_SUZ) {
                            result =
                                "6F30840B535558494E2E4444463031A5219F0C1E21500909283991510202860000215000283991512019010120501231FFFF"
                            inTU = false
                        }
                    "0006", "535A504B5F5A5959" ->
                        if (cardType == TYPE_SUZ_CIKA) {
                            result = ""
                            inTU = false
                        }
                    "A00000000386980701" ->
                        if (!wait && !tuOnly) when (cardType) {
                            TYPE_CU, TYPE_SPTC -> {
                                result =
                                    "6F328409A00000000386980701A5259F0801029F0C1E869820007590FFFF820520007D93847E0526E0B820180724202410160214"
                                inTU = false
                            }
                            TYPE_HZ -> {
                                result =
                                    "6F2E8409A00000000386980701A5219F0C1E847531000000000000003100310000015107302820191225206912250000"
                                inTU = false
                            }
                        }
                    "A00000000386980702" ->
                        if (cardType == TYPE_HZ) {
                            result =
                                "6F308409A00000000386980702A5239F0C200001310000000000000000000000000000000000000000000000000000000000"
                            inTU = false
                            app = 2
                        }
                    "A00000000386980703" ->
                        if (cardType == TYPE_HZ) {
                            result =
                                "6F308409A00000000386980703A5239F0C20000131000000000000000000000000000000000000000000000000000000000000000000"
                            inTU = false
                            app = 1
                        }
                    "D156000015B9ABB9B2D3A6D3C3" ->
                        if (cardType == TYPE_TFT) {
                            result = ""
                            inTU = false
                        }
                    "1002" ->
                        if (cardType == TYPE_TFT) {
                            result = ""
                            app = 1
                            inTU = false
                        }
                }
            }
            // PIN
            "0020" -> {
                if (cardType == TYPE_SUZ)
                    result = ""
            }
            // READ INFO
            "00B0" -> {
                // switch by P1, P2 is offset (because bit 8 of P1 is 1)
                when (tran.p1 and 0x1F) {
                    0x15 -> result = if (inTU)
                        when (tuType) {
                            TU_BJ -> "01011000FFFFFFFF02010310517005678901234520190806204012310000"
                            TU_NANTONG -> "12343060FFFFFFFF02010310517005678901234520190806204012310000"
                            TU_SH -> "02002900FFFFFFFF02010310477001234567890120191224202412240114"
                            else -> tuIssuer + "FFFFFFFF02010310517005678901234520190806204012310000"
                        }
                    else when (cardType) {
                        TYPE_YCT -> "FFFFFFFFFFFFFFFF5100000712345678030002FFFFFFFF201509162025123120150916218121010100000000052B000101015100000712345678030000000000FF8000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"
                        TYPE_SUZ -> "21500909123456780202860000215000123456782019010120501231FFFF"
                        TYPE_SZT -> "0000000000000000FD4400005180000015D9589C201712012027120110100000"
                        TYPE_CU -> cuIssuer + "000100000001116000116001013BBD5220200613202112310000"
                        TYPE_TFT ->
                            if (app == 0)
                                "544661000201000003000000610002018010238120170927202709270102000000"
                            else
                                "544661000201000003000000610002018010238120170927203003040102000000"
                        TYPE_SPTC -> "869820007590FFFF820520005C899A8D2495D0EC20200103202505111B14"
                        TYPE_HZ -> "847531000000000000003100310000019856102320191225206912250000"
                        else -> null
                    }
                    0x05 -> result = when (cardType) {
                        TYPE_BJ -> "000000001400000000302001141204000100FFFFFFFFFFFFFFFFFFFFFFFFFFFF"
                        TYPE_ZHENJIANG -> "869821207590FFFF050021203030343739313930201902220000000000000000333231313030343739313930"
                        //11 -> "06004743010F650501"
                        TYPE_SUZ_CIKA -> "06004477010E100201" // BALANCE 0, EXPIRY 2019.12
                        TYPE_HZ -> "1700002099010101E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                        else -> null
                    }
                    0x06 -> result = when (cardType) {
                        //11 -> "3C00000000000247434A3102EE00000000474301490000040002" // BALANCE 50, EXPIRY 2021
                        //11 -> "3C000000000002447745E8017200000000447701490000040002" // BALANCE 0, EXPIRY 2019.12
                        TYPE_SUZ_CIKA -> "3E00000000000245DC48C302E80000000045DC01490000040002" // EXPIRY 2020.12
                        else -> null
                    }
                    0x11 ->
                        result = "00FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"
                    0x16 ->
                        result =
                            "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"
                    0x17 ->
                        if (inTU) result =
                            "000001561000100000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                    0x1A ->
                        if (cardType == TYPE_TFT)
                            result =
                                "190000001900000020200000202000002020000C202000142020001E1900000019000000190000001900000019000000"
                    0x04 ->
                        if (cardType == TYPE_BJ)
                            result =
                                "1000751136141285060200300000000000000000000000002018030920240309000000000000009156000014FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"
                }
                if (result != null && tran.p2 > 0 && result.length / 2 > tran.p2) {
                    result = result.substring(tran.p2 * 2)
                }
            }
            // READ RECORD
            "00B2" -> {
                // switch by P1 P2
                if (inTU) when (tuType) {
                    // TU
                    TU_BJ -> when (tran.p2 shr 3) {
                        // 0x02 R1
                        0x02 -> if (tran.p1 == 1)
                            result = "0112060000000100000000000000000000000000"
                        0x03 -> if (tran.p1 == 1)
                            result =
                                "013020011320320627200110001DB00000000000000000000000000000000000000000000000000000000000000000000000"
                        0x18 -> result = listOf(
                            //"0002000000000000000941310064482220200523135920", // suzhou tram
                            "001A000000000000A00900003101165220200301002723",
                            "0001000000000000000941310043055120151031095400", // nanjing bike
                            "001A000000000000A00912345678901220111111111111", // zhenjiang topup
                            "001A000000000000A00941310116627420101010101010",
                            "0002000000000001F40941310614672320200902141153", // hz metro
                            "0001000000000000000941310614846620200902134559", // hz metro
                            "0001000000000000000941318003352620210501154509", // chongqing metro
                            "0000000000000003E80200000000000020210430234603", // chongqing top up
                            "00030000000000005A0941310626235220220416091412", // meishan 66
                            "00020000000000005A0941310130995020220416084402", // meishan 16
                            "0002000000000001F40941310190818920210630172524", // sx metro
                            "0001000000000000000941310178614120210630164850", // sx metro
                            "0002000000000001F40941318004196020210616090132", // ty metro
                            "0001000000000000000941318004210120210616090000", // ty metro
                            "0002000000000001F40941310135753720210630172524", // sx ic
                            "0001000000000000000941310184558920211008122505", // hefei metro
                        ).getOrNull(tran.p1 - 1)
                        0x1A -> result = when (tran.p1) {
                            1 -> "27017D0101000000000000043835025810581012205810FFFFFFFF122058100000000001007513090090251000000000000000000041310173800800004131013299462019120711350020191207115635000000BE1E0900000000000004B50000011D0000000000000000000000000000000000000000000000000000000000"
                            2 -> "27027D010100000000000007708502100011011000FFFFFFFF000100291030303033323834350000001009007597201911291325450000012CAB100011011000FFFFFFFF000100290D30303033323834350000001009007598201911291330460000006400C8000000000000000000000000000000000000000000000000DDF3"
                            else -> null
                        }
                        0x1E -> result = listOf(
                            /* FORMAT
                             T1 POS            T2 LINE         AMOUNT  BALANCE DATE          CITY INSTIT
                             */
                            "0303224219000000000103221900000000000000000000044C20210501154509690011656900FFFFFFFF000000000000", // chongqing metro on
                            "0303224219000000000103221900000000000000000000044C20210501154509690011656900FFFFFFFF000000000000", // chongqing metro on duplicate
                            "0600004131062623520200000066010064000005A00000029420220416084402667014256670FFFFFFFF000000000000", // meishan 66
                            "0600004131013099500200000016000064000005A0000002EE20220416084402667014256670FFFFFFFF000000000000", // meishan 16
                            "044131800419600000011F000201000000000000000000044C20210616090132173013041730FFFFFFFF000000000000", // luliang
                            "0300000000021407024200020214000100000000000000044C19911009202505361012273610FFFFFFFF000000000000", // hefei metro
                            /*"060000413100644822020000020002310000000000E803000020200523135920305011423050FFFFFFFF000000000000", // suzhou tram
                            "0600004131008443880205060000783509000001900000044C20200301002723783511355850FFFFFFFF000000000000", // zhuhai bus
                            "0600004131061525510200000001003100000001900000044C19900301190734453013664530FFFFFFFF000000000000", // zibo query
                            "0600004131011662740200390000503000000000000000044C20101010101010503012135030FFFFFFFF000000000000", // xuchang coach
                            "0630500000014004130200000000710000000000000000044C19900301190734100001021000FFFFFFFF000000000000", // xi'an bus 7100
                            "0630500000014004130200000501000000000000000000044C19900301190734667014256670FFFFFFFF000000000000", // meishan t501
                            "0630500000014004130260010000000000000000000000044C19900301190734710012017910FFFFFFFF000000000000", // xi'an bus no 7100
                            "0630500000014004130208000000000000000000780000044C19900301190734451000114510FFFFFFFF000000000000", // jinan bus discount
                            "0830500000014004130100080021000000000000000000044C19900301190734581012205810FFFFFFFF000000000000", // guangzhou bupiao
                            "0600004131006309590208220000000000000000000000044C19900301190734304011403040FFFFFFFF000000000000", // changzhou b22
                            "0600000000137000050200060000000400000000000000044C20200516055013301010083010FFFFFFFF000000000000", // nanjing ferry bagua
                            "0400004131012005870200C90036000000000001900000044C20200512082655302011273020FFFFFFFF000000000000", // yixing 201
                            "0600004131061071810200050000000000000000000000044C20200512080753735115447090FFFFFFFF000000000000", // jiayuguan
                            "0430500000034104020100030041000000000001900000044C20200408171307332003473320FFFFFFFF000000000000", // ningbo metro
                            "0330500000315204020100310052000000000000000000044C20200408164504332003473320FFFFFFFF000000000000", // ningbo metro yinfeng
                            "060000000005380171FF08910171000100000012C00000000020200121110637301010083010FFFFFFFF000000000000", // nanjing supermarket
                            "03791000000225310801020019002A0000000000000000044C20200725144407791012017910FFFFFFFF000000000000", // xi'an metro
                            "00791000000425025F0200040025000000000000000000044C20200723104639791012017910FFFFFFFF000000000000", // xi'an metro bupiao
                            "0400003008290000170E520017003E0000000001900000044C20200716121327100001011000FFFFFFFF000000000000", // bj huairou
                            "0200004131012113140250000000000000000000000000044C20200714163016375502068040FFFFFFFF000000000000", // xi'an bus type 02
                            "0600000000800185040200000009000000000001900000044C2020071917570423801227361031049902000000000000", // chaohu bus
                            "0400000900090015050200730004900000000001900000444C20200724120454100011011000FFFFFFFF000000000000", // baoding bus
                            "0300000900090015040200730001900000000000000000044C20200724110840100011011000FFFFFFFF000000000000", // baoding bus
                            "040000413101727507010300030A000000000001900000044C20200805200841551002195510FFFFFFFF000000000000", // changsha metro
                            "0341310172731373130105002900000000000000000000044C20200805192706551002195510FFFFFFFF000000000000", // changsha metro
                            "0400000000070307990103001F03020000000001900000044C20200731165245302011273020FFFFFFFF000000000000", // wx metro
                            "0382100000013204080200010032000000000000000000044C20200801083001821004428210FFFFFFFF000000000000", // lanzhou metro
                            "0300004131018234700200180000000000000001900000044C20200807171310821014428210FFFFFFFF000000000000", // lanzhou bus
                            "0600004131060853800209990000000000000001900000044C20200111200905230012273610FFFFFFFF000000000000", // HEFEI BRT
                            "0600000002360004020203E9000000001F000001900000044C20200823163350518002215840FFFFFFFF000000000000", // sz tram
                            "0445200000015305090100010053000000000001900000044C20200801134916452011984520FFFFFFFF000000000000", // qingdao metro
                            "0345200000034006170200000000000000000000000000044C20200801131135452011984520FFFFFFFF000000000000", // qingdao metro
                            "0600000000137000080200010000000400000001900000044C20201203185414301010083010FFFFFFFF000000000000", // nanjing zhongshan pier
                            "06000041310124069802000C000C04B200000001900000044C20201114093317337013714680FFFFFFFF000000000000", // dezhou 12
                            "0600004131012406980201BC0000000000000001900000044C20201114093317337013714680FFFFFFFF000000000000", // dezhou K1
                            "0600004131000818990202010000000000000001900000044C20201205132608491011303160FFFFFFFF000000000000", // taixing 201
                            "0600004131014430230203150001000300000001900000044C20201128132948471013724710FFFFFFFF000000000000", // liaocheng 315
                            "0600004131014704320275700000000000000001900000044C20201108153945332013473320FFFFFFFF000000000000", // ningbo 757
                            "0600004131060259660270950000000000000001900000044C20201108151416332013473320FFFFFFFF000000000000", // ningbo 709-5
                            "0600004131061525350232580001002600000001900000044C20201205103251453013664530FFFFFFFF000000000000", // zibo 258
                            "0000004131061523950200890000000000000001900000044C20200926121300453013664530FFFFFFFF000000000000", // zibo 137
                            "0200004131061023040240550000000000000001900000044C20190810135400557003935570FFFFFFFF000000000000", // yueyang y55
                            "060000413101123163021F480000000000000001900000085C20201201143358222000002220FFFFFFFF000000000000", // dalian brt
                            "040000000090021819010090000200000000000FA0000003E820201217113208290012002900FFFFFFFF000000000000", // maglev longyang rd
                            "030000000090011A140100900001000000000000000000138820201217110501290012002900FFFFFFFF000000000000", // maglev pudong
                            "0200004131015130610201400000000000000001900000085C20200103125853705012737050FFFFFFFF000000000000", // hengyang 140
                            "0600004131012183680200031113000000000001900000085C20201213165829221002172210FFFFFFFF000000000000", // shenyang v113
                            "0600004131012190330200030010000000000001900000085C20201213145619221002172210FFFFFFFF000000000000", // shenyang hunheleifeng
                            "00221041310603683901000200E7000300000001900000085C20201119191549221012172210FFFFFFFF000000000000", // shenyang metro single-journey ticket
                            "0600002500010046830209680000000000000001900000085C20201206161216451013654510FFFFFFFF000000000000", // jinan 10 zhi
                            "0400004131061754080100700004000000000001F40000085C20201206101413581012205810FFFFFFFF000000000000", // guangzhou intercity shiling
                            "0300004131061754230100700006000000000000000000085C20201206094710581012205810FFFFFFFF000000000000", // guangzhou intercity huadu
                            "0600004131015076990202100000000000000001900000085C20201204214155300014005670FFFFFFFF000000000000", // huaihua bus
                            "04000000000233060E0100020033000000000001900000085C20201121100003303001463030FFFFFFFF000000000000", // xuzhou line 2 xinyuandadao
                            "0300000000023406070100020034000000000000000000085C20201121100003303001463030FFFFFFFF000000000000", // xuzhou line 2 xinchengqudong
                            "0600004131010877780207110001000400000001900000085C20201121164545303011463030FFFFFFFF000000000000", // xuzhou 11 kuai
                            "06000041310145672702001C00120A8000000001900000085C20201219084158000013704660FFFFFFFF000000000000", // binzhou 28
                            "0600004131018108400211110000690009000001900000085C20201218181257551002195510FFFFFFFF000000000000", // changsha w111
                            "047910000005311F940100050031000000000001900000085C20201228102014791012017910FFFFFFFF000000000000", // xi'an line 5 xibeigongyedaxue
                            "037910413106112164010006002F000000000000000000085C20201228100911791002017910FFFFFFFF000000000000", // xi'an line 6 keji lu
                            "0430500000044904040100040049000000000001900000085C20201223111123332013473320FFFFFFFF000000000000", // ningbo line 4 ailiu
                            "0330500000045104070100040051000000000000000000085C20201223110259332013473320FFFFFFFF000000000000", // ningbo line 4 songjiangdonglu
                            "0400000000182115030100180021000000000001900000085C20201227140456290012002900FFFFFFFF000000000000", // shanghai line 18 hangtou
                            "030000000018221A550100180022000000000000000000085C20201227140056290012002900FFFFFFFF000000000000", // shanghai line 18 xiasha
                            "06000041310142100104000000000000000000010E0000085C20201221063657393011343930FFFFFFFF000000000000", // sanming jiangle taxi
                            "040000300959000466015F000D004B0000000001900000085C20210101133204100001011000FFFFFFFF000000000000", // beijing dongguantounan
                            "0300003001690004010110002900380000000000000000085C20210101115109100001011000FFFFFFFF000000000000", // beijing wanquanheqiao
                            "040000300799000004014F0015004F0000000001900000085C20210101175639100001011000FFFFFFFF000000000000", // beijing t1 dinghaiyuan
                            "030000300799000120014F002F004F0000000000000000085C20210101165050100001011000FFFFFFFF000000000000", // beijing t1 quzhuang
                            "0600004131062064770207010001009900000001900000085C20201230142841269013402690FFFFFFFF000000000000", // daqing kuai 1
                            "0600004131017802890200250001000500000001900000085C20210103173310303011463030FFFFFFFF000000000000", // peixian 25
                            "0300004131006071330260330021006000000001900000085C20210103161025303011463030FFFFFFFF000000000000", // peixian 33
                            "0600004131800286260000000200000000000001900000085C2021011114153226401337264031049703000000000000", // qiqihar 2
                            "0600004131012990320232030000305209000001900000085C20210118094853305215453052FFFFFFFF000000000000", // kunshan weiba 3
                            "0600004131061166520208100001001900000001900000085C2021010513352533801D4F542EFFFFFFFF000000000000", // jin lan express
                            "0600004131006461710212800001009000000001900000085C20210123092040312011013120FFFFFFFF000000000000", // baoying 128
                            "0400000420290007760275330010002000000001900000085C20210123122745100011011000FFFFFFFF000000000000", // mi 3
                            "030000000015321A600100150032000000000000000000085C20210123121945290012002900FFFFFFFF000000000000", // line 15 south sta
                            "0401014235000000000101013500000000000001900000085C20210203211202690011656900FFFFFFFF000000000000", // cq line 1 chaotianmen
                            "0303184225000000000103182500000000000000000000085C20210203210028690011656900FFFFFFFF000000000000", // cq line 3 lianglukou
                            "0600004501000015CC0200003028000000000001900000085C2021013112545361101402611000000000000000000000", // nanning d28
                            "0600004501000018100200001010000000000001900000085C2021013114423961101402611000002800000000000000", // nanning k10
                            "0600004501000016CB0200002009000000000001900000085C2021012919353461101402611000003300000000000000", // nanning w9
                            "0600004501000031810200059019000000000001900000085C2021012919151961101402611000001F00000000000000", // nanning w19
                            "0900004131018731150204290001641000000001900000085C2021013011421784200000000012156410000000000000", // haikou 29
                            "0900004131000946230203370001641000000001900000085C2021012810313284200000000012156410000000000000", // haikou 37 kuai
                            "0900004131010748570201060001641000000001900000085C2021020110125984200000000012156410000000000000", // haikou 106
                            "0641756B00100000006409202001021330000001900000085C2020010213300033201347332000000000000000000000", // ningbo old
                            "0600004131012019530200650000001800000001900000085C20210307100806799012077990FFFFFFFF000000000000", // hanzhong 101
                            "0600004131012019980227110000000300000001900000085C20210307091506799012077990FFFFFFFF000000000000", // hanzhong 1
                            "0600004131000009530221520000000000000001900000085C20210219150027314011023140FFFFFFFF000000000000", // zhenjiang jxz
                            "0600004131062064180209060001009900000001900000085C20210304172627269013402690FFFFFFFF000000000000", // daqing huan 6
                            "04000000100900780002926B000B000100000001900000085C20210208170654100011011000FFFFFFFF000000000000", // beijing 483 tqkc
                            "06000000010903664402953B0002000100000001900000085C20210218180126100011011000FFFFFFFF000000000000", // beijing kszd 23
                            "0300000001090140340293D80010000100000001900000085C20210208172020100011011000FFFFFFFF000000000000", // beijing tq hzj
                            "040000413101765871020209000069001F000001900000085C20210217161615690011396900FFFFFFFF000000000000", // chongqing 209
                            "0450154105000000000150150500000000000001900000085C20210218192302690011656900FFFFFFFF000000000000", // chongqing beizhan nan
                            "0900004131018705380204010001641000000001900000085C2021020717440184200000000012156410000000000000", // haikou zhuanxian 3
                            "0900004131018705380225010000000000000001900000085C20210207174401511000005110FFFFFFFF000000000000", // zhumadian Y1
                            "0900004131018705380200110100000000000001900000085C20210207174401511000005110FFFFFFFF000000000000", // zhumadian K1
                            "0600004131018226910280030000000000000001900000085C20210412115122821014428210FFFFFFFF000000000000", // lanzhou xinqu 3
                            "0600004131000541040292100001001200000001900000085C20210408115924312011013120FFFFFFFF000000000000", // yz shiyuanhui
                            "0600004131000541040202500000000000000001900000085C20210408115924586000015860FFFFFFFF000000000000", // shantou ferry
                            "0600004131018341140221050001010200000001900000085C20210425162542791012017910FFFFFFFF000000000000", // xi'an huizhan 5
                            "0600004131018145230200000058000000000001900000085C20210430155909835000011000FFFFFFFF000000000000", // yili bus
                            "0345200000016004090100010060000000000001900000085C20210503180213452011984520FFFFFFFF000000000000", // qingdao 1 goucha
                            "03452000000154040D0100010054000000000000000000085C20210101094200452011984520FFFFFFFF000000000000", // qingdao 1 xianjiazhai
                            "0641313205000000010203011430134300000001900000085C20210422182923305001423050FFFFFFFF000000000000", // suzhou gaofeng 14
                            "0600004131012593700223F20000000000000001900000085C20210501143623222011642220FFFFFFFF000000000000", // dalian 202
                            "0600004131011166030212030000000000000001900000085C20201210143523222011642220FFFFFFFF000000000000", // dalian 1203
                            "0600004131011703560200200001000900000001900000085C20210507145749228013242280FFFFFFFF000000000000", // yingkou
                            "06000041310176709302EA690000000200000001900000085C20210428111045562013975620FFFFFFFF000000000000", // loudi 9
                            "040000010019001630022B2C000F000100000001900000085C20210428111045100011011000FFFFFFFF000000000000", // xiong'an gaotie 2 lvyou
                            "03000004401900003002D2F10010002300000000000000085C20210501184403100011011000FFFFFFFF000000000000", // xinghangcheng 1
                            "0641313205000000010201200760820100000001900000085C20210502151520305001423050FFFFFFFF000000000000", // sz hubinshiji 2
                            "0400004131018851610105020218000000000001900000085C20210501223037701012937010FFFFFFFF000000000000", // guiyang yan'an xilu
                            "0300004131018846480105020508000000000000000000085C20210501184403701012937010FFFFFFFF000000000000", // guiyang guanshan xilu
                            "060000413101123163021F480000000000000001900000085C20201201143358222000002220FFFFFFFF000000000000", // dalian brt zhangqianbeilu
                            "0600004131011231000210230000000000000001900000085C20210707113202222011642220FFFFFFFF000000000000", // dalian 1012
                            "0600004131006573440131010000162009000001900000085C20210523190733138011711380FFFFFFFF000000000000", // zhangjiakou k1
                            "0600004131013018310221010000305209000001900000085C20200601153822305215453052FFFFFFFF000000000000", // kunshan 210a
                            "0900004131015673820000038900000000000001900000085C20210704120936100001984520FFFFFFFF000000000000", // qingdao 389
                            "0241310135840400000A11351506000000000001900000085C20210618180424332003473320FFFFFFFF000000000000", // ningbo train
                            "0141310139323600000A11311A05000000000000000000085C20210618170807332003473320FFFFFFFF000000000000", // yuyao train
                            "0241310135818200000A01211502000000000001900000085C20210717071728332003473320FFFFFFFF000000000000", // qianqing
                            "0141310135792800000A01111A02000000000000000000085C20210717065414332003473320FFFFFFFF000000000000", // hangzhounan
                            "0600000000000000000200200001479000000001900000085C2021070813242900000000000012154790000000000000", // laiwu 20
                            "0600004131011143800229010000000000000001900000085C20210624184403222011642220FFFFFFFF000000000000", // dalian kaifaqu
                            "0400004131013153130102080208000000000001900000085C20210620122156304011403040FFFFFFFF000000000000", // changzhou qingfeng park
                            "0300004131013155690102180218000000000000000000085C20210620115420304011403040FFFFFFFF000000000000", // changzhou ziyun
                            "0430500000053504140100050035000000000001900000085C20210629124648305001423050FFFFFFFF000000000000", // suzhou laodonglu
                            "0330500000053704160100050037000000000000000000085C20210629123917305001423050FFFFFFFF000000000000", // suzhou nanmen
                            "0400004131800454880101000700000000000001900000085C20210620192753881004678810FFFFFFFF000000000000", // urumqi metro
                            "0300004131800455170101001300000000000000000000085C20210620191132881004678810FFFFFFFF000000000000", // urumqi metro
                            "0600004131006809580270290001007000000001900000085C20210606150128312011013120FFFFFFFF000000000000", // yizheng K29
                            "0800004131012613050107020145000000000001900000085C2021070509241439100003500050000001000000000000", // fuzhou nanmendou bom
                            "06000041310615193102670051510000C8000001900000085C20210613133848667014256670FFFFFFFF000000000000", // meishan t51
                            "0600004131017622920234620000010800000001900000085C20210625150657290012002900FFFFFFFF000000000000", // shanghai huqingying
                            "0410134117000000000110131700000000000001900000085C20210717191656690011656900FFFFFFFF000000000000", // chongqing beizhan
                            "0304034004000000000104030400000000000000000000085C20210717190717690011656900FFFFFFFF000000000000", // chongqing toutang
                            "04452000000838050A0200000003000000000001900000085C20210717191656452011984520FFFFFFFF000000000000", // qingdao jiaozhoubeizhan
                            "03452000000830051C0200000003000000000000000000085C20210717190717452011984520FFFFFFFF000000000000", // qingdao hogndaokjg
                            "0600004131015455370270160000452009000001900000085C20210719133753452011984520FFFFFFFF000000000000", // qingdao tram
                            "0641310607566900000200103344556630000001900000085C20210719085200452011984520FFFFFFFF000000000000", // qingdao 10
                            "0641310607566900000201120000452009000001900000085C20210719085200452011984520FFFFFFFF000000000000", // qingdao 112
                            "0600004131060594500237190000013800000001900000085C2021081413282529003032303032393030000000000000", // suidao 9 -> pudong 73
                            "06000041310075847402C7590000242000000001900000085C20210618184504242001182420FFFFFFFF000000000000", // jilin 33 off
                            "03000041310603228702C7590500242000000000000000085C20210618183451242001182420FFFFFFFF000000000000", // jilin 33 on
                            "0600004131014994550249800000000000000001900000085C20210816173855332013473320FFFFFFFF000000000000", // ningbo dingzhi 8
                            "0400004131017647260100010001690000000001900000085C20210717141044690011396900FFFFFFFF000000000000", // chongqing tram chengyu
                            "030000413101764845010001000A690000000000000000085C20210717131627690011396900FFFFFFFF000000000000", // chongqing tram xiushuiwan
                            "0441310119512551250101002100000000000001900000085C20210614194927881004678810FFFFFFFF000000000000", // urumqi metro
                            "0300004131011951090100040045000000000000000000085C20210709160311421003554210FFFFFFFF000000000000", // nanchang line 4
                            "0400004131015751970100610002000000000001900000085C2021081915581558801220588000000000000000000000", // foshan tram
                            "0300004131015752210100610001000000000000000000085C2021081915463258801220588000000000000000000000", // foshan tram
                            "0241310135770100000A01231502000000000001900000085C20210824170114332003473320FFFFFFFF000000000000", // sx ic shangyu
                            "0300004131061760920100180005000000000000000000085C2021081915463258101220581000000000000000000000", // gz shaxi
                            "0400000000260102260226010226000000000001900000085C20210911081103290012002900FFFFFFFF000000000000", // sh brt wangyuanlu
                            "0600004131011161750231260000000000000001900000085C20210801132907222011642220FFFFFFFF000000000000", // dalian jinzhou 117 non-ac
                            "064131320500000001020024C990100200000001900000085C20210902165936305001423050FFFFFFFF000000000000", // sz bandao lvyou
                            "0400004131060699710103000100910000000001900000085C20210904125243451003654510FFFFFFFF000000000000", // jinan longdong
                            "0300004131060697580103000400910000000000000000085C20210904123814451003654510FFFFFFFF000000000000", // jinan aotizhongxin
                            "0800004131015379500209410000012400000001900000085C2021082813492429003032303032393030000000000000", // 941 BUPIAO
                            "0400004131060699710100030027000000000001900000085C20210904125243303030303030FFFFFFFF000000000000", // xuzhou shifandaxue
                            "0300000000413106120102FF28FF000000000000000000085C20210919154212261011592610FFFFFFFF000000000000", // harbin shangzhidajie
                            "0400004131062610660101001400910000000001900000085C20210915095055493002644930FFFFFFFF000000000000", // luoyang qingniangong
                            "0600004131013696120200150000188600000001900000085C20211003091747690004236610FFFFFFFF000000000000", // guangyuan 21
                            "0600004131019087450100000007000000000001900000085C20211010104005335011493350FFFFFFFF000000000000", // jiaxing tram
                            "0730500000015407020200010054000000000001900000085C20190627124305305001423050FFFFFFFF000000000000", // suzhou bom
                            "0600000000040300410100030029000300000001900000085C20211109160427301010083010FFFFFFFF000000000000", // nanjing bom
                            "0600004131060299240200211301000000000001900000085C20211227070648493015584930FFFFFFFF000000000000", // luoyang 301
                            "05413101390297000002A1000000000500000001900000085C20201031100523471002644930FFFFFFFF000000000000", // luoyang 106
                            "0400000000060410530104001D04000000000001900000085C20211211085336302011273020FFFFFFFF000000000000", // wx tiyuzx
                            "0330500000055004150100050050000000000000000000085C20211229180051332003473320FFFFFFFF000000000000", // ningbo angmenggang
                            "040000000014511A580100140051000000000001900000085C20211230110603290012002900FFFFFFFF000000000000", // sh guiqiaolu
                            "030000000014211A540100140021000000000000000000085C20211230074516290012002900FFFFFFFF000000000000", // sh fengbang*/
                            "0600000000137600130292360000001900000001900000085C20211118145952301010083010FFFFFFFF000000000000", // jurong 236
                            "040000042019000015029C990021001F00000001900000085C20211121151745100011011000FFFFFFFF000000000000", // bj jiao 89
                            "030000042019000076029C660005001F00000000000000085C20211128132452100011011000FFFFFFFF000000000000", // bj mi 38
                            "0600000000131012400290940000002300000001900000085C20211118123605301010083010FFFFFFFF000000000000", // nj 94
                            "04000000010904104102A4160003000100000001900000085C20211222105713100011011000FFFFFFFF000000000000", // bj lin 6
                            "0300000010090093330290EC0030000100000000000000085C20211223115903100011011000FFFFFFFF000000000000", // bj fengheying bus
                            "0600004131018819880265020000881009000001900000085C20211205195718881014678810FFFFFFFF000000000000", // urumqi 6502
                            "0600004131018819880254010000881009000001900000085C20211205195718881014678810FFFFFFFF000000000000", // urumqi S401
                            "0600004131018819880216010000881009000001900000085C20211205195718881014678810FFFFFFFF000000000000", // urumqi BRT1
                            "0600004131012013170230010001000200000001900000085C20220104110249232013272320FFFFFFFF000000000000", // panjin BRT
                            "040000413101807679010D243106222000000001900000085C20220103131212222001642220FFFFFFFF000000000000", // dalian line 13 zhenxingjie
                            "0300003001790001430111003700390000000000000000085C20211231085646100001011000FFFFFFFF000000000000", // bj line 17 beishenshu
                            "0200004131011094220200380000000000000001900000085C20210610154815166012737050FFFFFFFF000000000000", // tongren 38
                            "0600004131011968480200010000000000000001900000085C20211207195813302011273020FFFFFFFF000000000000", // jiangyin 1
                            "0600004131011165670231280000000000000001900000085C20220101120736222011642220FFFFFFFF000000000000", // dalian 2001
                            "06000041310063114002005500000101000000003C0000091020210925140958304011403040FFFFFFFF210925140125", // changzhou transfer
                            "060000413100630925020056000001010100000078000009FC20210925140125304011403040FFFFFFFF210925140125", // changzhou transfer start
                            "0400004131060865080101240124020100000001900000085C20220120190508304011403040FFFFFFFF220120190408", // changzhou huanqiugang
                            "0300004131060863240101160116020100000000000000085C20220120190408304011403040FFFFFFFF220120190408", // changzhou wenhuagong
                            "0345200000013504230100010035000000000000000000085C20220119084141452011984520FFFFFFFF000000000000", // qingdao zhan
                            "054131006297240000032722000000030000000078000009FC2021122816514103120170134000000000000000000000", // baoding
                            "0600001100191000470000000000100000000078780000000020220403172936100011011000FFFFFFFF000000000000", // bj tuizi
                            "040000413101259936010D15320422200000000078000009FC20220101143239222001642220FFFFFFFF000000000000", // dalian shisanli
                            "030912401000000000010912100000000000000000000009FC20220214101411690011656900FFFFFFFF000000000000", // cq guanyinqiao
                        ).getOrNull(tran.p1 - 1)
                    }
                    TU_SH -> when (tran.p2 shr 3) {
                        0x06 -> result = when (tran.p1) {
                            1 -> "02240064FF00004E200220008399015020200925184908"
                            2 -> "01C10057B700004E200220008399015020200825191655"
                            3 -> "0155005B3B00004E200220008399197720200706190214"
                            4 -> "00E4005B9F00004E200220008399024120200514114101"
                            5 -> "00830053CF00004E200220008399164420200402114202"
                            6 -> "004A002E4F000027100220001200006420200310132848"
                            7 -> "001700267F000027100220008399025020200223192150"
                            8 -> "0003000D1B00000D1B0220001200009020200214114339"
                            9 -> "0002000000000000000220009999002820191224102400"
                            10 -> "0001000000000000000220009299002820191224102400"
                            else -> null
                        }
                        0x07 -> result = when (tran.p1) {
                            1 -> "63505037C800273D00007E4A7D004CE9"
                            2 -> "09502407C800EF3D00007E4A7AA6EC64"
                            3 -> "09502197C800B73E00007E4A744A18BC"
                            4 -> "09501005C8007F3F00007E4A72AF3C11"
                            5 -> "09502301C800474000007E4A6C6074F8"
                            6 -> "09502537C8000F4100007E4A6A9B7870"
                            7 -> "055077296400D74100007E4A6483200A"
                            8 -> "01902445C8003B4200007E4A6413CCCE"
                            9 -> "058002516400034300007E4A6344C021"
                            10 -> "058000856400674300007E4A63065849"
                            else -> null
                        }
                        0x10 -> result = when (tran.p1) {
                            2 -> "009301101520002010120001C800005C"
                            3 -> "009301101216192010120001C8000074"
                            else -> null
                        }
                        0x11 -> result = when (tran.p1) {
                            1 -> "4120101210210118650000000000002E"
                            2 -> "882010121036012219C80001C80000B7"
                            else -> null
                        }
                        0x18 -> result = when (tran.p1) {
                            1 -> "0260003D27000000C80920001150503720201015200019"
                            2 -> "025F003DEF000000C80920001150240720201015103859"
                            3 -> "025E003EB7000000C80920001150219720201014171006"
                            4 -> "025D003F7F000000C80920001150100520201014104715"
                            5 -> "025C004047000000C80920001150230120201013173229"
                            6 -> "025B00410F000000C80920001150253720201013102730"
                            7 -> "025A0041D7000000640920001150772920201012180308"
                            8 -> "025900423B000000C80920001190244520201012161951"
                            9 -> "0258004303000000640920001180025120201012130448"
                            10 -> "0257004367000000640920001180008520201012120622"
                            else -> null
                        }
                        0x1A -> result = when (tran.p1) {
                            1 -> "27017D0101000000000000043835025810581012205810FFFFFFFF122058100000000001007513090090251000000000000000000041310173800800004131013299462019120711350020191207115635000000BE1E0900000000000004B50000011D0000000000000000000000000000000000000000000000000000000000"
                            2 -> "27027D010100000000000007708502100011011000FFFFFFFF000100291030303033323834350000001009007597201911291325450000012CAB100011011000FFFFFFFF000100290D30303033323834350000001009007598201911291330460000006400C8000000000000000000000000000000000000000000000000DDF3"
                            else -> null
                        }
                        0x1E -> result = when (tran.p1) {
                            1 -> "06413100000249040663009300000000000000006400004E5720201015200019290012002900FFFFFFFF000000000000" // current trip
                            2 -> "04305000000249040601000200490000000000006400004E5720200523160944305001423050FFFFFFFF000000000000"
                            3 -> "0600004131011662740200390000503000000000000000044C20101010101010503012135030FFFFFFFF000000000000" // xuchang coach
                            4 -> "0630500000014004130200000000710000000000000000044C19900301190734100001021000FFFFFFFF000000000000" // xi'an bus 7100
                            5 -> "0630500000014004130200000501000000000000000000044C19900301190734667014256670FFFFFFFF000000000000" // meishan t501
                            6 -> "0630500000014004130260010000000000000000000000044C19900301190734710012017910FFFFFFFF000000000000" // xi'an bus no 7100
                            7 -> "0630500000014004130208000000000000000000780000044C19900301190734451000114510FFFFFFFF000000000000" // jinan bus discount
                            8 -> "0830500000014004130100080021000000000000000000044C19900301190734581012205810FFFFFFFF000000000000" // guangzhou bupiao
                            9 -> "0600004131006309590208220000000000000000000000044C19900301190734304011403040FFFFFFFF000000000000" // changzhou b22
                            10 -> "0600000000137000050200060000000400000000000000044C20200516055013301010083010FFFFFFFF000000000000" // nanjing ferry bagua
                            11 -> "0400004131012005870200C90036000000000001900000044C20200512082655302011273020FFFFFFFF000000000000" // yixing 201
                            12 -> "0600004131061071810200050000000000000000000000044C20200512080753735115447090FFFFFFFF000000000000" // jiayuguan
                            13 -> "0430500000034104020100030041000000000001900000044C20200408171307332003473320FFFFFFFF000000000000" // ningbo metro
                            14 -> "0330500000315204020100310052000000000000000000044C20200408164504332003473320FFFFFFFF000000000000" // ningbo metro yinfeng
                            15 -> "060000000005380171FF08910171000100000012C00000000020200121110637301010083010FFFFFFFF000000000000" // nanjing supermarket
                            16 -> "03791000000225310801020019002A0000000000000000044C20200725144407791012017910FFFFFFFF000000000000" // xi'an metro
                            17 -> "00791000000425025F0200040025000000000000000000044C20200723104639791012017910FFFFFFFF000000000000" // xi'an metro bupiao
                            18 -> "0400003008290000170E520017003E0000000001900000044C20200716121327100001011000FFFFFFFF000000000000" // bj huairou
                            19 -> "0200004131012113140250000000000000000000000000044C20200714163016375502068040FFFFFFFF000000000000" // xi'an bus type 02
                            20 -> "0600004131012090840200030001000100000001900000044C20200719175704375012313750FFFFFFFF000000000000" // quanjiao bus
                            21 -> "0400000900090015050200730004900000000001900000444C20200724120454100011011000FFFFFFFF000000000000" // baoding bus
                            22 -> "0300000900090015040200730001900000000000000000044C20200724110840100011011000FFFFFFFF000000000000" // baoding bus
                            23 -> "040000413101727507010300030A000000000001900000044C20200805200841551002195510FFFFFFFF000000000000" // changsha metro
                            24 -> "0341310172731373130105002900000000000000000000044C20200805192706551002195510FFFFFFFF000000000000" // changsha metro
                            25 -> "0422104131060364340100020115000300000001900000044C20200731165245221012172210FFFFFFFF000000000000"
                            26 -> "0600000000002200600210020001010100000001900000044C20200801083001100011131121FFFFFFFF000000000000"
                            27 -> "0800004131014186190101230703000000000000000000044C20200807171310393011343930FFFFFFFF000000000000"
                            28 -> "060000413100082183020065010F8DD709000001900000044C2020011120090530501FFFFFFFFFFFFFFF000000000000"
                            29 -> "0600000002360004020203E9000000001F000001900000044C20200823163350518002215840FFFFFFFF000000000000"
                            30 -> "0445200000113205020200110032000000000001900000044C20200801134916452011984520FFFFFFFF000000000000"
                            31 -> "0345200000034006170200000000000000000000000000044C20200801131135452011984520FFFFFFFF000000000000"
                            else -> null
                        }
                    }
                    TU_GEN -> when (tran.p2 shr 3) {
                        0x18 -> result = when (tran.p1) {
                            1 -> "000D00017C000000F00621420100058120200513145536"
                            2 -> "000C00026C000000C80941310119838520200513133828"
                            3 -> "000B000334000000C80941310119772220200513133224"
                            4 -> "000A0003FC000003E80220009507000120200511133850"
                            5 -> "0009000014000000500621420100033420200402155807"
                            6 -> "0008000064000000640941310119775420200402144843"
                            7 -> "00070000C8000000F00621420100058420200316155017"
                            8 -> "00060001B8000000A00621420100058120200122153459"
                            9 -> "0005000000000001F40941310614672320200902141153" // hz metro
                            10 -> "0004000000000000000941310614846620200902134559" // hz metro
                            11 -> "0003000258000000C802e6e6ee12095520200121152435" // zhengjiang service center
                            12 -> "0002000320000000C80288012003265020201023213456" // gz tu topup
                            13 -> "0001000000000000C80600010020135720200101100000" // chengdu tu
                            14 -> "0002000000000003E80212345678901220191228144152" // zhenjiang topup
                            15 -> "00020000000000012C0621008005109620200918150720" // supermarket
                            else -> null
                        }
                        // 0x19 (gz metro)
                        0x19 -> result = when (tran.p1) {
                            1 -> "012E00191200000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                            else -> null
                        }
                        0x1A -> result = when (tran.p1) {
                            1 -> if (metro && inGate)
                                "27017D010100000000000000000001" + metroCity + "0000" +
                                        metroInstitution + "FFFFFFFF" + "0000000000000000" + metroStationIn +
                                        "0000000000000000" + metroTerminalIn + "0000000000000000" +
                                        df1.format(Date(Date().time - 60 * 60 * 1000)) +
                                        "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                            else
                                "27017D0101000000000000043835025810581012205810FFFFFFFF122058100000000001007513090090251000000000000000000041310173800800004131013299462019120711350020191207115635000000BE1E0900000000000004B50000011D0000000000000000000000000000000000000000000000000000000000"
                            2 -> "27027D010100000000000007708502100011011000FFFFFFFF000100291030303033323834350000001009007597201911291325450000012CAB100011011000FFFFFFFF000100290D30303033323834350000001009007598201911291330460000006400C8000000000000000000000000000000000000000000000000DDF3"
                            else -> null
                        }
                        0x1E -> result = when (tran.p1) {
                            in 1..10 -> "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                            else -> null
                        }
                    }
                }
                else when (cardType) {
                    // CU
                    TYPE_HZ ->
                        when (app) {
                            0 -> when (tran.p2 shr 3) {
                                // 0x17 first occurence
                                0x17 -> result = when (tran.p1) {
                                    1 -> "012E000000310004001002000000005E04A8E90000000000000EE90100015E04A8E90100000020590000000104001002"
                                    6 -> if (metro && inGate)
                                        "062E0031013100040253160000000005360118" + "%08X".format(
                                            Date().time / 1000 - 60 * 60 - 946656000
                                        ) +
                                                "0000000005" + df2.format(Date(Date().time - 60 * 60 * 1000)) +
                                                "00000000000005360106000000B60000"
                                    else "062E0031033100010525370000016C0106015026E12A7F0000016C092020090100000000000001010109000000B60000"
                                    else -> null
                                }
                                0x18 -> result = when (tran.p1) {
                                    1 -> "000D000000000000F00931000403062020210702083913" // sx line 1
                                    2 -> "000C000000000000000931000402539420210702083828" // hz line 5
                                    3 -> "000C000000000000640931000403062220210722162920" // gnq bom
                                    4 -> "000C000000000000000931000403008920210722142138" // tongjiu
                                    5 -> "000B000000000000000931500101123720210722142138" // shangyu
                                    else -> null
                                }
                            }
                            else -> when (tran.p2 shr 3) {
                                0x17 -> result = when (tran.p1) {
                                    1 -> "012E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                                    6 -> "062E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
                                    else -> null
                                }
                            }
                        }
                    TYPE_YCT -> when (tran.p2 shr 3) {
                        // 0x08 R1 & R17 (p2's last 3 bits 0 means P1 is identifier: find first C8 in 0x08)
                        0x08 -> result = when (tran.p1) {
                            1 -> "1814001912010E0F0000000000000000000000000000"
                            17, 0xC8 ->
                                //"C8540000000102003BCEC2EE010000169261" + posList[1] + "04101610" + posList[1] + "0410163BCEC2EE010000169261000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014105C"
                                "C8540000000002003BCEB67101000020061830010430062002150430103BCE9E63010000203169000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C4E7"
                            else -> null
                        }
                        0x18 -> result = when (tran.p1) {
                            1 -> "000A0000000000029909" + prefix + "002BC1207112517"
                            2 -> "00090000000000000009" + prefix + "100001207095711"
                            3 -> "00080000000000029909" + prefix + "202BC1207095717"
                            4 -> "00070000000000000009" + prefix + "300001207095311"
                            5 -> "00060000000000000009" + prefix + "400001207095311"
                            6 -> "00050000000000000009" + prefix + "500001207095311"
                            7 -> "00040000000000000009" + prefix + "600001207095311"
                            8 -> "00030000000000000009" + prefix + "700001207095311"
                            9 -> "00020000000000000009" + prefix + "800001207095311"
                            10 -> "00010000000000000009" + prefix + "900001207095311"
                            11 -> "0002000000000013880288012002549113881207095314"
                            12 -> "0001000000000000000200001600202920190715085953"
                            else -> null
                        }
                    }
                    TYPE_SZT -> when (tran.p2 shr 3) {
                        0x08 -> if (tran.p1 == 1)
                            result =
                                "011E0000B1A0AD0F486A484BD600304F00000000000000000000000000000000"
                        0x18 -> result = when (tran.p1) {
                            1 -> "001A000000000000A00900003101165220191024184245"
                            2 -> "0019000000000002EE0900008600135920191024173608"
                            3 -> "0018000000000002EE0900008600235920191024173608"
                            4 -> "0017000000000002EE0900008600335920191024173608"
                            5 -> "0016000000000002EE0900008600435920191024173608"
                            6 -> "0015000000000002EE0900008600535920191024173608"
                            7 -> "0014000000000002EE0900008600635920191024173608"
                            8 -> "0013000000000002EE0900008600735920191024173608"
                            9 -> "0012000000000002EE0900008600835920191024173608"
                            10 -> "0011000000000002EE0900008600935920191024173608"
                            else -> null
                        }
                    }
                    TYPE_TFT -> if (app == 0) when (tran.p2 shr 3) {
                        0x18 -> result = when (tran.p1) {
                            1 -> "0002000000000000A00900003101165220191024184245"
                            2 -> "0001000000000002EE0900008600135900000000173608"
                            else -> null
                        }
                    } else when (tran.p2 shr 3) {
                        // cika
                        0x09 -> result = when (tran.p1) {
                            1 -> "0002000000000000021200010003684420200405180244"
                            2 -> "0001000000000000021200010006025220200304100910"
                            else -> null
                        }
                        0x18 -> result = when (tran.p1) {
                            1 -> "0003000000000000000900010022345820200304163658"
                            2 -> "0002000000000000000900010022285220200304162908"
                            3 -> "0001000000000000020900010021322520200304161002"
                            else -> null
                        }
                    }
                    TYPE_SPTC -> when (tran.p2 shr 3) {
                        0x07 -> result = when (tran.p1) {
                            1 -> "63300063C8006C0200007E456B6670E0"
                            2 -> "88031503C800340300007E456B6060AF"
                            3 -> "95070001E803FC0300007E455B66C849"
                            4 -> "516009326400640000007E4413B0AC35"
                            5 -> "51633430C800580200007E41ABD88C52"
                            6 -> "88004091C800200300007E41AB884CBB"
                            7 -> "34004091C800200300007E41AB884CBB"
                            8 -> "95070001E803E80300007E41AB749CEF"
                            9 -> "999900230000000000007E411AA8309E"
                            10 -> "929900230000000000007E411AA83095"
                            else -> null
                        }
                        0x18 -> result = when (tran.p1) {
                            1 -> "000D00017C000000F00621420100058120200513145536"
                            2 -> "000C00026C000000C80920006330006320200513133828" // 07 1
                            3 -> "000B000334000000C80920005203150320200513133224" // 07 2
                            4 -> "000A0003FC000003E80220009507000120200511133850"
                            5 -> "0009000014000000500621420100033420200402155807"
                            6 -> "0008000064000000640920005160093220200402144843" // 07 4
                            7 -> "00070000C8000000F00621420100058420200316155017"
                            8 -> "00060001B8000000A00621420100058120200122153459"
                            9 -> "0005000000000001F40941310614672320200902141153"
                            10 -> "0004000000000000000941310614846620200902134559"
                            11 -> "0003000258000000C80920004163343020200121152435" // 07 5
                            12 -> "0002000320000000C80920003200409120200121140819" // 07 6
                            13 -> "0002000320000000C80920000112784120200121140819" // 07 7
                            14 -> "0001000000000000C80600010020135720200101100000" // chengdu tu
                            15 -> "00020000000000012C0931500101046720200121110637" // yuyao train
                            else -> null
                        }
                        0x06 -> result = when (tran.p1) {
                            1 -> "000A0003FC000003E80220009507000120200511133850" // same as 4
                            2 -> "00000003FC000003E80220009507000120190510133850" // same as 15
                            3 -> "00000004FC000003E80220009507000120180510133850"
                            else -> null
                        }
                    }
                    TYPE_SUZ_CIKA -> when (tran.p2 shr 3) {
                        // suzhou metro in/out
                        0x19 -> if (tran.p1 == 1)
                            result =
                                "0030000001610403514556990000000000000002000000000000000004540405514560C747D0010000000000000000000000"
                        0x18 -> result = when (tran.p1) {
                            1 -> "0003000000000000010921500040055220200502220307"
                            2 -> "0002000000000000000921500001027820200502212625"
                            3 -> "0001000000000000320200000000000020120416132322"
                            else -> null
                        }
                    }
                    TYPE_CU -> when (tran.p2 shr 3) {
                        0x18 -> result = when (tran.p1) {
                            1 -> "0003000000000000010931210501297620200502220307" // shaoxing bike
                            2 -> "0002000000000000000931200101787720200502212625" // shaoxing bus
                            else -> null
                        }
                        0x10 -> result = when (tran.p1) {
                            1 -> "092E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" // fake
                            2 -> "01180000000060F13C8F08001800360022181630261900000000"
                            3 -> "030C000000000000000000000000"
                            else -> null
                        }
                    }
                }
            }
            // Balance
            "805C" -> result = when (tran.p1) {
                0x05 -> "00002B220007A1200000000000000000"
                // 01 02 03
                else -> "00002B22"
            }
            // Get challenge
            "0084" -> result = "C620857FF5D967C2"
            // External auth
            "0082" -> result = ""
            // Get data
            "80CA" -> result =
                if (inTU) ""
                else if (cardType == TYPE_HZ) "04FFF83E302F6EB256"
                else "850526E0B885AC58FC"
            // Init for load
            "8050" -> {
                // Same format for TU and CU
                //result = "00000B2200020000000100" + "E9F0DEEA"
                if (tran.lc == 11 && metro) {
                    val s = if (inGate) "Out" else "In"
                    val t = if (inTU) "TU" else "CU"
                    terminals.value += "${df.format(Date())},$metroLine,$metroStationName,$metroRemark,$t,$s," +
                            tran.data.takeLast(12) + "\n"
                    val notification =
                        RingtoneManager.getDefaultUri(RingtoneManager.TYPE_NOTIFICATION)
                    val r = RingtoneManager.getRingtone(applicationContext, notification)
                    r.play()
                    wait = true
                }
            }
            // Update record
            "80DC" -> result = ""
            // GZ Metro
            "C4FE" -> result = "41070B16BEF8F42110010184"
            //"C4FE" -> result = "BA9A8B9F34000035C0490032"
            "C4FB" -> result = "0002000A"
        }

        if (tran.result == "") {
            if (result != null) {
                if (tran.le > 0 && result.length / 2 > tran.le) {
                    result = result.take(tran.le * 2)
                }
                tran.result = result + STATUS_SUCCESS
            } else {
                tran.result = STATUS_FAILED
            }
        }

        rawMessage.value += "Response: ${tran.result}\n\n"
        return hexStringToByteArray(tran.result)

    }
}